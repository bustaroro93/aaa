=====================================================================
   ğŸ° TENNISTITAN - PP_02b ODDS LAYER (NASA SOTA)
======================================================================
   2026-01-08 18:01:16
======================================================================

============================================================
   LOAD ODDS DATA
============================================================
  ğŸ“‚ Fichier: C:\Users\Administrateur\Tennis POLAR v3\data_raw\atp_tennis.csv
  ğŸ“Š Lignes brutes: 66,681
  ğŸ“‹ Colonnes: ['Tournament', 'Date', 'Series', 'Court', 'Surface', 'Round', 'Best of', 'Player_1', 'Player_2', 'Winner', 'Rank_1', 'Rank_2', 'Pts_1', 'Pts_2', 'Odd_1', 'Odd_2', 'Score']

  âœ… Lignes valides: 62,809
  ğŸ“… PÃ©riode: 2001-01-01 â†’ 2025-11-16
  ğŸ¾ Tournois: 254

============================================================
   LOAD MATCHES DATA
============================================================
  ğŸ“Š Matchs: 544,245
  ğŸ“… PÃ©riode: 1942-08-01 â†’ 2025-09-01
shape: (5, 2)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ match_date â”† week_start â”‚
â”‚ ---        â”† ---        â”‚
â”‚ date       â”† date       â”‚
â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•¡
â”‚ 1942-08-01 â”† 1942-07-26 â”‚
â”‚ 1942-08-01 â”† 1942-07-26 â”‚
â”‚ 1942-08-01 â”† 1942-07-26 â”‚
â”‚ 1942-08-01 â”† 1942-07-26 â”‚
â”‚ 1942-08-01 â”† 1942-07-26 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
shape: (5, 2)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ date_parsed â”† week_start â”‚
â”‚ ---         â”† ---        â”‚
â”‚ date        â”† date       â”‚
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•¡
â”‚ 2001-01-01  â”† 2000-12-31 â”‚
â”‚ 2001-01-01  â”† 2000-12-31 â”‚
â”‚ 2001-01-01  â”† 2000-12-31 â”‚
â”‚ 2001-01-01  â”† 2000-12-31 â”‚
â”‚ 2001-01-01  â”† 2000-12-31 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

============================================================
   MATCHING ODDS TO MATCHES (v2 ROBUST)
============================================================
  ğŸ” Matching 62,809 cotes...
  ğŸ“… Matching par date (Â±7 jours)
     Progression: 0/62,809 (matchÃ©s: 0)
     Progression: 10,000/62,809 (matchÃ©s: 5,129)
     Progression: 20,000/62,809 (matchÃ©s: 13,208)
     Progression: 30,000/62,809 (matchÃ©s: 21,941)
     Progression: 40,000/62,809 (matchÃ©s: 30,395)
     Progression: 50,000/62,809 (matchÃ©s: 38,988)
     Progression: 60,000/62,809 (matchÃ©s: 46,993)

  â±ï¸  Temps: 32.2s
  âœ… MatchÃ©s: 48,674 (77.5%)
  âŒ Non matchÃ©s: 14,135
  ğŸ“Š Par type: {'P1=W,P2=L': 24582, 'P1=L,P2=W': 24073, 'partial': 19}

============================================================
   COMPUTE ODDS FEATURES
============================================================
  ğŸ”„ AprÃ¨s dedup SOTA: 48,472 matchs uniques
  ğŸ“Š Matchs avec cotes: 48,472
  ğŸ“ˆ Odds winner mean: 1.82
  ğŸ“‰ Odds loser mean: 3.44
  ğŸ’° Marge bookmaker mean: 6.7%

============================================================
   SAVE ODDS LAYER
============================================================
  âœ… Features: C:\Users\Administrateur\Tennis POLAR v3\data_clean\features\odds_layer\odds_features.parquet
  âœ… Rapport: C:\Users\Administrateur\Tennis POLAR v3\data_clean\features\odds_layer\matching_report.json

  ğŸ“Š Total matchs avec cotes: 48,472

============================================================
   NASA SOTA: CREATING LONG FORMAT
============================================================

============================================================
   CREATE ODDS LONG FORMAT (NASA SOTA)
============================================================
  ğŸ“Š Matchs avec odds: 48,472
  ğŸ“‹ Colonnes optionnelles disponibles: ['bookmaker_margin', 'odds_match_confidence']
  âœ… Format long crÃ©Ã©: 96,944 rows
  ğŸ“Š Colonnes: ['custom_match_id', 'player_id', 'odds', 'odds_implied_prob', 'bookmaker_margin', 'odds_match_confidence']
  âœ… Format long sauvegardÃ©: C:\Users\Administrateur\Tennis POLAR v3\data_clean\features\odds_layer\odds_long.parquet
  ğŸ“Š Shape: (96944, 6)

============================================================
   NASA SOTA: SANITY CHECK
============================================================
  ğŸ“Š Test matches (2001+): 10,000

============================================================
   ATTACH ODDS A/B (NASA SOTA - NO LEAK)
============================================================
  ğŸ“‹ Match ID col: custom_match_id
  ğŸ“‹ Player A col: winner_id
  ğŸ“‹ Player B col: loser_id
  âœ… Coverage odds_A: 18.9%
  âœ… Coverage odds_B: 18.9%
  ğŸ“Š Matchs testÃ©s avec odds: 1,891
  ğŸ“Š % winners favoris (odds_A < odds_B): 66.5%
  âœ… Ratio dans la plage attendue (55-85%)

============================================================
   SOTA VERIFICATION
============================================================
  ğŸ” Duplicates sur custom_match_id: 0
  ğŸ“Š % odds_winner < odds_loser (global): 68.46%
  ğŸ“Š % odds_winner < odds_loser (confâ‰¥95): 68.69% (24,421 rows)

======================================================================
   âœ… PP_02b ODDS LAYER COMPLETE (NASA SOTA)
======================================================================
   â±ï¸  Temps total: 39.5s
   ğŸ“Š Matchs avec cotes: 48,472
   ğŸ“ˆ Taux de matching: 77.5%

ğŸ“ OUTPUT FILES:
   â€¢ odds_features.parquet  (format winner/loser - legacy)
   â€¢ odds_long.parquet      (format player_id - NASA SOTA)
   â€¢ matching_report.json

ğŸš€ UTILISATION:
   # Dans PP_MERGE (design actuel winner/loser):
   odds_long = pl.read_parquet(ODDS_DIR / "odds_long.parquet")
   df = attach_odds_AB_no_leak(df, odds_long, 
                                playerA_col="winner_id", 
                                playerB_col="loser_id")
   
   # AprÃ¨s shuffle A/B (futur):
   df = attach_odds_AB_no_leak(df, odds_long,
                                playerA_col="player_id_A",
                                playerB_col="player_id_B")
